<ng-template #tmplNode let-node="node">
  <div class="node-item" [attr.data-id]="node.uuid" [attr.id]="'node-' + node.uuid">
    <div class="node-title" (click)="expandClick(node)">
      {{ node.children.length ? (node.isExpanded ? "-&nbsp;" : "+") : "&nbsp;&nbsp;&nbsp;" }} &nbsp;&nbsp;&nbsp;
      {{ node.name }}
      <span class="item-notes">
        ({{ node.children.length }}{{ node.children.length ? ", expanded: " + !!node.isExpanded : "" }})</span
      >
    </div>

    <div
      *ngIf="node.isExpanded && node.children.length"
      class="node-children"
      cdkDropList
      [cdkDropListData]="node.children"
      [id]="node.uuid"
      [cdkDropListConnectedTo]="dropTargetIds"
      (cdkDropListDropped)="drop($event)"
      [cdkDropListSortingDisabled]="true"
    >
      <div *ngFor="let child of node.children" cdkDrag [cdkDragData]="child.uuid" (cdkDragMoved)="dragMoved($event)">
        <ng-container *ngTemplateOutlet="tmplNode; context: { node: child }"></ng-container>
      </div>
    </div>
  </div>
</ng-template>

<div
  cdkDropList
  [cdkDropListData]="nodes"
  [id]="'main'"
  [cdkDropListConnectedTo]="dropTargetIds"
  (cdkDropListDropped)="drop($event)"
  [cdkDropListSortingDisabled]="true"
>
  <div *ngFor="let node of nodes" cdkDrag [cdkDragData]="node.uuid" (cdkDragMoved)="dragMoved($event)">
    <ng-container *ngTemplateOutlet="tmplNode; context: { node: node }"></ng-container>
  </div>
</div>
