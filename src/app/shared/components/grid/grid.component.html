<kendo-grid
  [data]="data$ | async"
  [loading]="loading || false"
  [pageSize]="virtualPageSize"
  [skip]="state?.skip"
  [filter]="state?.filter"
  [sort]="state?.sort"
  [pageable]="true"
  [sortable]="true"
  [filterable]="true"
  [reorderable]="true"
  [resizable]="true"
  (filterChange)="onFilterChange($event)"
  (sortChange)="onSortChange($event)"
  (pageChange)="onPageChange($event)"
  (columnReorder)="onColumnReorder($event, columns)"
  (cellClick)="onCellClick($event)"
  (columnResize)="onResizeChange($event, columns)"
  (excelExport)="onExcelExport($event)"
  [rowHeight]="gridRowHeight"
  scrollable="virtual"
  style="width: 100%"
  *ngIf="columns$ | async as columns"
>
  <ng-container *ngFor="let columnConfig of columns">
    <ng-container *ngIf="uiConfigApplications$ === null || (uiConfigApplications$ | async) as uiConfigApplications">
      <kendo-grid-column
        *ngIf="!columnConfig.hidden && isColumnEnabled(uiConfigApplications, columnConfig)"
        [field]="columnConfig.field"
        [title]="columnConfig.title"
        [sortable]="columnConfig.sortable ?? true"
        [filter]="columnConfig.filter ?? 'text'"
        [width]="
          columnConfig.width !== undefined
            ? columnConfig.width
            : columnConfig.style === 'date'
            ? defaultDateColumnWidth
            : defaultColumnWidth
        "
        [sticky]="columnConfig.isSticky ?? false"
        [minResizableWidth]="
          columnConfig.minResizableWidth !== undefined
            ? columnConfig.minResizableWidth
            : columnConfig.filter === 'date'
            ? defaultMinimumDateColumnWidth
            : columnConfig.style === 'primary'
            ? defaultPrimaryColumnMinimumWidth
            : defaultMinimumColumnWidth
        "
        headerClass="mygrid-header-cell"
      >
        <ng-template kendoGridHeaderTemplate let-column let-columnIndex="columnIndex">
          <app-paragraph [bold]="true" color="primary-dark" class="sort-icon"
            >{{ column.title }}

            <app-tooltip *ngIf="columnConfig.helpText" [alignCenter]="true" [text]="columnConfig.helpText">
              <app-help-icon></app-help-icon>
            </app-tooltip>

            <ng-container *ngIf="state?.sort as sortItem">
              <ng-container *ngIf="sortItem[0].field === column.field">
                <ng-container *ngIf="sortItem[0].dir === 'asc'">
                  <app-arrow-up-icon></app-arrow-up-icon>
                </ng-container>
                <ng-container *ngIf="sortItem[0].dir === 'desc'">
                  <app-arrow-down-icon></app-arrow-down-icon>
                </ng-container>
              </ng-container>
            </ng-container>
          </app-paragraph>
        </ng-template>

        <ng-template kendoGridFilterCellTemplate let-filter let-columnFilter="column">
          <ng-container *ngIf="!columnConfig.noFilter">
            <app-string-filter
              [column]="columnFilter"
              [filter]="filter"
              *ngIf="columnFilter.filter === 'text' && !columnConfig.extraFilter"
              [entityType]="entityType"
              class="overflow-hidden-container"
            ></app-string-filter>
            <app-numeric-filter
              [column]="columnFilter"
              [filter]="filter"
              *ngIf="columnFilter.filter === 'numeric'"
              [entityType]="entityType"
              class="overflow-hidden-container"
            ></app-numeric-filter>
            <app-date-filter
              [column]="columnFilter"
              [filter]="filter"
              *ngIf="columnFilter.filter === 'date'"
              [entityType]="entityType"
              class="overflow-hidden-container"
            ></app-date-filter>
            <app-dropdown-filter
              [column]="columnFilter"
              [filter]="filter"
              [options]="columnConfig.extraData"
              [entityType]="entityType"
              *ngIf="
                columnFilter.filter === 'boolean' ||
                (columnFilter.filter === 'text' && columnConfig.extraFilter === 'enum')
              "
              class="overflow-hidden-container"
            ></app-dropdown-filter>
            <app-unit-dropdown-filter
              *ngIf="columnFilter.filter === 'text' && columnConfig.extraFilter === 'organization-unit'"
              [column]="columnFilter"
              [filter]="filter"
              class="dropdown-inline-display"
              [entityType]="entityType"
            ></app-unit-dropdown-filter>
            <app-choice-type-dropdown-filter
              [column]="columnFilter"
              [filter]="filter"
              [choiceTypeName]="columnConfig.extraData"
              [sortOptions]="columnConfig.sortFilter"
              *ngIf="columnFilter.filter === 'text' && columnConfig.extraFilter === 'choice-type'"
              [entityType]="entityType"
              class="overflow-hidden-container"
            ></app-choice-type-dropdown-filter>
            <app-dropdown-column-data-filter
              [column]="columnFilter"
              [filter]="filter"
              [serviceKey]="columnConfig.extraData"
              [columnName]="columnConfig.field"
              *ngIf="columnFilter.filter === 'text' && columnConfig.extraFilter === 'dropdown-from-column-data'"
              [entityType]="entityType"
              class="overflow-hidden-container"
            ></app-dropdown-column-data-filter>
            <app-choice-type-dropdown-filter
              [column]="columnFilter"
              [filter]="filter"
              [choiceTypeName]="columnConfig.extraData"
              [shouldFilterByChoiceTypeName]="true"
              *ngIf="columnFilter.filter === 'text' && columnConfig.extraFilter === 'choice-type-by-name'"
              [entityType]="entityType"
              class="overflow-hidden-container"
            ></app-choice-type-dropdown-filter>
          </ng-container>
        </ng-template>

        <ng-template
          *ngIf="columnConfig.style === 'default' || columnConfig.style === undefined"
          kendoGridCellTemplate
          let-dataItem
        >
          <app-paragraph [cropOnOverflow]="true">{{ dataItem | searchProperty : columnConfig.field }}</app-paragraph>
        </ng-template>
        <ng-template
          *ngIf="columnConfig.style === 'integer-with-thousands-separator'"
          kendoGridCellTemplate
          let-dataItem
        >
          <app-paragraph [cropOnOverflow]="true">{{
            dataItem | searchProperty : columnConfig.field | number : "1.0-0"
          }}</app-paragraph>
        </ng-template>
        <ng-template *ngIf="columnConfig.style === 'default-wrap'" kendoGridCellTemplate let-dataItem>
          <app-paragraph [wrapOnOverflow]="true">{{ searchProperty(dataItem, columnConfig.field) }}</app-paragraph>
        </ng-template>
        <ng-template *ngIf="columnConfig.style === 'primary'" kendoGridCellTemplate let-dataItem>
          <div class="paragraph wrap-on-overflow bold-font">{{ dataItem | searchProperty : columnConfig.field }}</div>
        </ng-template>
        <ng-template
          *ngIf="columnConfig.style === 'chip' || columnConfig.style === 'reverse-chip'"
          kendoGridCellTemplate
          let-dataItem
        >
          <div class="items-center-container overflow-hidden-container">
            <app-status-chip
              [type]="columnConfig.entityType"
              [value]="dataItem | searchProperty : columnConfig.field"
              [valueDisplayType]="columnConfig.booleanValueDisplay"
              [reverseValues]="columnConfig.style === 'reverse-chip'"
            ></app-status-chip>
          </div>
        </ng-template>

        <ng-template *ngIf="columnConfig.style === 'boolean'" kendoGridCellTemplate let-dataItem>
          <div class="items-center-container">
            <app-boolean-circle
              [value]="(dataItem | searchProperty : columnConfig.field) === true"
              [positiveTooltipText]="columnConfig.tooltipPositiveText ?? ''"
              [negativeTooltipText]="columnConfig.tooltipNegativeText ?? ''"
            >
            </app-boolean-circle>
          </div>
        </ng-template>

        <ng-template *ngIf="columnConfig.style === 'date'" kendoGridCellTemplate let-dataItem>
          <app-paragraph>{{ dataItem | searchProperty : columnConfig.field | appDate }}</app-paragraph>
        </ng-template>

        <ng-template *ngIf="columnConfig.style === 'enum'" kendoGridCellTemplate let-dataItem>
          <app-paragraph [cropOnOverflow]="true">{{
            (dataItem | searchProperty : columnConfig.field)?.name
          }}</app-paragraph>
        </ng-template>

        <ng-template *ngIf="columnConfig.style === 'link'" kendoGridCellTemplate let-dataItem>
          <app-paragraph [cropOnOverflow]="true">
            <app-external-page-link
              [url]="dataItem | searchProperty : columnConfig.field"
              linkFontSize="small"
            ></app-external-page-link>
          </app-paragraph>
        </ng-template>

        <ng-template *ngIf="columnConfig.style === 'title-link'" kendoGridCellTemplate let-dataItem>
          <app-paragraph [cropOnOverflow]="true">
            <app-external-page-link
              [url]="searchProperty(dataItem, columnConfig.idField ?? '')"
              [title]="dataItem | searchProperty : columnConfig.field"
              linkFontSize="small"
            ></app-external-page-link>
          </app-paragraph>
        </ng-template>

        <ng-template
          *ngIf="columnConfig.style === 'page-link' && columnConfig.idField"
          kendoGridCellTemplate
          let-dataItem
        >
          <app-paragraph [cropOnOverflow]="true">
            <app-details-page-link
              *ngIf="searchProperty(dataItem, columnConfig.idField) as itemUuid"
              linkFontSize="small"
              [itemType]="columnConfig.entityType"
              [itemPath]="itemUuid"
              [subpagePath]="columnConfig.extraData"
              >{{ dataItem | searchProperty : columnConfig.field }}</app-details-page-link
            >
          </app-paragraph>
        </ng-template>

        <ng-template *ngIf="columnConfig.style === 'checkbox'" kendoGridCellTemplate let-dataItem>
          <div class="column-center-content">
            <ng-container *ngIf="columnConfig.idField">
              <app-checkbox
                *ngIf="entityType !== 'it-system'"
                [value]="dataItem | searchProperty : columnConfig.field"
                [disabled]="
                  columnConfig.permissionsField
                    ? searchProperty(dataItem, columnConfig.permissionsField) !== true
                    : false
                "
                (valueChange)="onCheckboxChange($event, searchProperty(dataItem, columnConfig.idField))"
              ></app-checkbox>
              <app-usage-proxy-checkbox
                *ngIf="entityType === 'it-system'"
                [checked]="dataItem | searchProperty : columnConfig.field"
                [disabled]="
                  columnConfig.permissionsField
                    ? searchProperty(dataItem, columnConfig.permissionsField) !== true || !createPermission
                    : false
                "
                [entityUuid]="searchProperty(dataItem, columnConfig.idField)"
                (attemptChange)="onCheckboxChange($event, searchProperty(dataItem, columnConfig.idField))"
              ></app-usage-proxy-checkbox>
            </ng-container>
          </div>
        </ng-template>

        <ng-template *ngIf="columnConfig.style === 'usages'" kendoGridCellTemplate let-dataItem>
          <app-usage-link
            *ngIf="columnConfig.dataField"
            [type]="columnConfig.entityType"
            [name]="searchProperty(dataItem, columnConfig.dataField)"
            [usingOrganizations]="dataItem | searchProperty : columnConfig.field"
            [rowEntityIdentifier]="searchProperty(dataItem, columnConfig.idField ?? 'Uuid')"
          >
          </app-usage-link>
        </ng-template>

        <ng-template
          *ngIf="columnConfig.style === 'page-link-array' || columnConfig.style === 'page-link-array-with-submodules'"
          kendoGridCellTemplate
          let-dataItem
        >
          <app-paragraph [cropOnOverflow]="true">
            <ng-container *ngIf="columnConfig.dataField">
              <div>
                <ng-container
                  *ngFor="let collectionItem of searchProperty(dataItem, columnConfig.dataField) as data; let i = index"
                >
                  <app-details-page-link
                    linkFontSize="small"
                    [itemType]="columnConfig.entityType"
                    [itemPath]="collectionItem.id"
                    [itemPathIncludesSubmodule]="columnConfig.style === 'page-link-array-with-submodules'"
                    [toolTip]="columnConfig.itemTooltipField ? searchProperty(collectionItem, columnConfig.itemTooltipField) : undefined"
                    >{{ collectionItem.value }}</app-details-page-link
                  >{{ i < data.length - 1 ? columnConfig.linkArraySeparator ?? ", " : "" }}
                </ng-container>
              </div>
            </ng-container>
          </app-paragraph>
        </ng-template>
        <ng-template *ngIf="columnConfig.style === 'uuid-to-name'" kendoGridCellTemplate let-dataItem>
          <app-paragraph *ngIf="columnConfig.dataField" [cropOnOverflow]="true">{{
            searchProperty(dataItem, columnConfig.dataField)
          }}</app-paragraph>
        </ng-template>

        <ng-template
          *ngIf="columnConfig.style === 'action-buttons' && (modifyPermission || deletePermission)"
          kendoGridCellTemplate
          let-dataItem
        >
          <div class="action-buttons-container">
            <ng-container *ngFor="let button of columnConfig.extraData">
              <app-icon-button
                *ngIf="button.type === 'edit' && modifyPermission"
                (click)="onModifyClick(dataItem)"
                data-cy="grid-edit-button"
              >
                <app-pencil-icon></app-pencil-icon>
              </app-icon-button>
              <app-icon-button
                *ngIf="button.type === 'delete' && deletePermission"
                (click)="onDeleteClick(dataItem)"
                data-cy="grid-delete-button"
              >
                <app-trashcan-icon></app-trashcan-icon>
              </app-icon-button>
            </ng-container>
          </div>
        </ng-template>
      </kendo-grid-column>
    </ng-container>
  </ng-container>

  <ng-template kendoPagerTemplate>
    <app-grid-paginator
      style="width: 100%"
      [state]="state"
      (pageSizeChange)="onPageSizeChange($event)"
    ></app-grid-paginator>
  </ng-template>
  <kendo-grid-messages
    pagerPage="Side"
    pagerOf="af"
    pagerItems="resultater"
    i18n-pagerPage
    i18n-pagerOf
    i18n-pagerItems
  ></kendo-grid-messages>

  <ng-template kendoGridLoadingTemplate>
    <div class="loading-container">
      <app-loading></app-loading>
    </div>
  </ng-template>
  <ng-template kendoGridNoRecordsTemplate>
    <div class="sticky-empty-state">
      <img src="assets/img/empty-system.svg" />
      <p i18n>Din søgning gav intet resultat</p>
    </div>
  </ng-template>

  <kendo-grid-excel [fileName]="getExportName()" [fetchData]="allData" [filterable]="true">
    <ng-container *ngFor="let column of getFilteredExportColumns$() | async">
      <ng-container *ngIf="column.style === 'excel-only'; else notExcelOnly">
        <kendo-excelexport-column [title]="column.title" [field]="column.title"></kendo-excelexport-column>
      </ng-container>
      <ng-template #notExcelOnly>
        <kendo-excelexport-column [title]="column.title" [field]="column.field"></kendo-excelexport-column>
      </ng-template>
    </ng-container>
  </kendo-grid-excel>

  <ng-template kendoGridToolbarTemplate position="bottom">
    <div class="toolbar-container">
      <app-paragraph i18n class="result-amount-padding">{{ totalDataAmount() }} resultater</app-paragraph>
    </div>
  </ng-template>
</kendo-grid>
